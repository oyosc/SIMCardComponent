<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for SIMCardComponent\common\cacheAble.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">SIMCardComponent/common/</a> cacheAble.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">17.86% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>15/84</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/23</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">17.86% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>15/84</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/**
 * Created by ljw on 2016/5/9.
 */
'use strict';
var _=require('lodash');
var redis = require('./redis');
var log = require('./log').getLogger();
var config = require('../config/config');
&nbsp;
/**=====&lt;1.缓存实现开始==========**/
<span class="fstat-no" title="function not covered" >function toCache(time, key, value) {</span>
<span class="cstat-no" title="statement not covered" >    if(value){</span>
<span class="cstat-no" title="statement not covered" >        var t = new Date();</span>
<span class="cstat-no" title="statement not covered" >        value = JSON.stringify(value);</span>
<span class="cstat-no" title="statement not covered" >        redis.set(key, value);</span>
<span class="cstat-no" title="statement not covered" >        if (time) {</span>
<span class="cstat-no" title="statement not covered" >            redis.expire(key, time);</span>
        }
<span class="cstat-no" title="statement not covered" >        if (config.debug) {</span>
<span class="cstat-no" title="statement not covered" >            var duration = new Date() - t;</span>
<span class="cstat-no" title="statement not covered" >            log.info('Cache set ' + key + ' ' + duration);</span>
        }
    }
}
&nbsp;
<span class="fstat-no" title="function not covered" >function fromCache(key){</span>
<span class="cstat-no" title="statement not covered" >    return new Promise(<span class="fstat-no" title="function not covered" >function(resolve){</span></span>
<span class="cstat-no" title="statement not covered" >        var t = new Date();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        redis.get(key, <span class="fstat-no" title="function not covered" >function(err, data) {</span></span>
<span class="cstat-no" title="statement not covered" >            if (!data) {</span>
<span class="cstat-no" title="statement not covered" >                return resolve(null);</span>
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            data = JSON.parse(data);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (config.debug) {</span>
<span class="cstat-no" title="statement not covered" >                var duration = new Date() - t;</span>
<span class="cstat-no" title="statement not covered" >                log.info('Cache get ' + key + ' ' + duration);</span>
            }
<span class="cstat-no" title="statement not covered" >            return resolve(data);</span>
        });
    })
}
<span class="fstat-no" title="function not covered" >function loadAndCacheData(time, key, fn, args) {</span>
<span class="cstat-no" title="statement not covered" >    var _cacheData = _.partial(toCache, time, key);</span>
<span class="cstat-no" title="statement not covered" >    return new Promise(<span class="fstat-no" title="function not covered" >function (resolve) {</span></span>
<span class="cstat-no" title="statement not covered" >        fn.apply(null, args).then(<span class="fstat-no" title="function not covered" >function(data){</span></span>
<span class="cstat-no" title="statement not covered" >            _cacheData(data);</span>
<span class="cstat-no" title="statement not covered" >            return resolve(data);</span>
        }).catch(<span class="fstat-no" title="function not covered" >function(err){</span>
<span class="cstat-no" title="statement not covered" >            console.log(err);</span>
        });
    });
}
&nbsp;
<span class="fstat-no" title="function not covered" >function getKey(args) {</span>
<span class="cstat-no" title="statement not covered" >    if(arguments.length != 0){</span>
<span class="cstat-no" title="statement not covered" >        var key = arguments[arguments.length - 1]</span>
    }
<span class="cstat-no" title="statement not covered" >    return key;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function withCache(time, keyBuilder, fn) {</span>
<span class="cstat-no" title="statement not covered" >    var args, key;</span>
<span class="cstat-no" title="statement not covered" >    args = Array.prototype.slice.call(arguments, 3);/</span>/转化成数组
<span class="cstat-no" title="statement not covered" >    key  = keyBuilder.apply(null, args); </span> // compute cache key
<span class="cstat-no" title="statement not covered" >    return new Promise(<span class="fstat-no" title="function not covered" >function(resolve){</span></span>
<span class="cstat-no" title="statement not covered" >        fromCache(key).then(<span class="fstat-no" title="function not covered" >function(datas){</span></span>
<span class="cstat-no" title="statement not covered" >            if (datas) {// cache hit</span>
<span class="cstat-no" title="statement not covered" >                console.log('cache hit');</span>
<span class="cstat-no" title="statement not covered" >                return resolve(datas);</span>
            }else {// cache missed
<span class="cstat-no" title="statement not covered" >                console.log('cache missed');</span>
<span class="cstat-no" title="statement not covered" >                return resolve(loadAndCacheData.call(null, time, key, fn, args));</span>
            }
        }).catch(<span class="fstat-no" title="function not covered" >function(err){</span>
<span class="cstat-no" title="statement not covered" >            console.log(err);</span>
        })
    })
}
&nbsp;
<span class="fstat-no" title="function not covered" >function cacheable(fn, time){</span>
<span class="cstat-no" title="statement not covered" >    return  _.partial(withCache, time, getKey, fn);</span>
}
/**=====缓存实现结束==========&gt;**/
&nbsp;
/**&lt;=====2.清空缓存实现开始=============**/
<span class="fstat-no" title="function not covered" >function clear(key){</span>
<span class="cstat-no" title="statement not covered" >    redis.del(key);</span>
}
<span class="fstat-no" title="function not covered" >function getDelKey(args) {</span>
<span class="cstat-no" title="statement not covered" >    var key;</span>
<span class="cstat-no" title="statement not covered" >    if(arguments.length != 0){</span>
<span class="cstat-no" title="statement not covered" >        key = arguments[0]</span>
    }
<span class="cstat-no" title="statement not covered" >    return key;</span>
}
<span class="fstat-no" title="function not covered" >function withClear(keyBuilder, fn) {</span>
<span class="cstat-no" title="statement not covered" >    var args = Array.prototype.slice.call(arguments, 2);</span>
<span class="cstat-no" title="statement not covered" >    var key  = keyBuilder.apply(null, args);</span>
<span class="cstat-no" title="statement not covered" >    clear(key);/</span>/先清缓存然后调用具体业务
<span class="cstat-no" title="statement not covered" >    return  new Promise(<span class="fstat-no" title="function not covered" >function (resolve) {</span></span>
<span class="cstat-no" title="statement not covered" >        fn.apply(null, args).then(<span class="fstat-no" title="function not covered" >function(data){</span></span>
<span class="cstat-no" title="statement not covered" >            return resolve(data);</span>
        }).catch(<span class="fstat-no" title="function not covered" >function(err){</span>
<span class="cstat-no" title="statement not covered" >            console.log(err);</span>
        });
    });
}
&nbsp;
<span class="fstat-no" title="function not covered" >function clearable(fn){</span>
<span class="cstat-no" title="statement not covered" >    return _.partial(withClear, getDelKey, fn);</span>
}
/**=====清空缓存实现结束=============&gt;**/
&nbsp;
module.exports = {
    /**
     * 声明式缓存
     * 使用方式：（前提是fn的最后一个参数是回调函数,回调函数第一个参数是err类似function(err,data1,data2,data3){}）
     * var cache = require('./cacheable');
     * var service  = require('../service/service1');
     * cache.cacheable(service,    'method1',       time);
     * @param m ：module对象
     * @param fn ：要缓存的函数名
     * @param opts   1000
     * key:缓存命名空间，time:过期时间
     */
    cacheable:<span class="fstat-no" title="function not covered" >function(m, fn, time){</span>
<span class="cstat-no" title="statement not covered" >        if(!m){</span>
<span class="cstat-no" title="statement not covered" >            throw 'm 不能为空';</span>
        }
<span class="cstat-no" title="statement not covered" >        if(!fn){</span>
<span class="cstat-no" title="statement not covered" >            throw 'fn 不能为空';</span>
        }
<span class="cstat-no" title="statement not covered" >        if(!m[fn]){</span>
<span class="cstat-no" title="statement not covered" >            throw 'm 不存在fn函数';</span>
        }
<span class="cstat-no" title="statement not covered" >        if(!time || isNaN(time)){//默认缓存一小时</span>
<span class="cstat-no" title="statement not covered" >            time = 1000 * 60 * 60;</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        m[fn] = cacheable(m[fn], time);</span>
    },
    /**
     * 当调用某个方法时自动清空缓存
     * 使用方式：
     * var cache = require('./cacheable');
     * var service  = require('../service/service1');
     * cache.clear(service,    'method1','forum.service.service1');
     * @param m ：module对象
     * @param fn ：函数名
     * @param 缓存命名空间
     */
    clear:<span class="fstat-no" title="function not covered" >function(m, fn){</span>
<span class="cstat-no" title="statement not covered" >        if(!m){</span>
<span class="cstat-no" title="statement not covered" >            throw 'm 不能为空';</span>
        }
<span class="cstat-no" title="statement not covered" >        if(!fn){</span>
<span class="cstat-no" title="statement not covered" >            throw 'fn 不能为空';</span>
        }
<span class="cstat-no" title="statement not covered" >        if(!m[fn]){</span>
<span class="cstat-no" title="statement not covered" >            throw 'm 不存在fn函数';</span>
        }
<span class="cstat-no" title="statement not covered" >        m[fn] = clearable(m[fn]);</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Jul 14 2016 11:09:59 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
